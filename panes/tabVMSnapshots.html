<!-- 

	VM Snapshots Pane
	Copyright (C) 2011 Ian Moore (imoore76 at yahoo dot com)
	
	$Id$

 -->
<div id='vboxTabVMSnapshots' class='vboxInvisible' style='display: none; width:100%;'>

	<table class='vboxInvisible' style='height: 99%; width: 99%'>
		<tr style='vertical-align: top; height: 1%'>
			<td><div id='vboxSnapshotToolbar'></div></td>
		</tr>
		<tr style='vertical-align: top;'>
			<td><ul style='min-height: 400px' class='vboxBordered vboxTreeView' id='vboxSnapshotList'></ul></td>
		</tr>
	</table>
<!-- 

	New Snapshot Dialog

 -->
	<div id='vboxSnapshotNew' class='vboxDialogContent' style='display: none;'>
		<table class='vboxVertical'>
			<tr style='vertical-align: top'>
				<th>
					<img id='vboxSnapshotNewImg' src='images/vbox/os_other.png' />
				</th>
				<td>
					<div style='height: 100%'>
						<div class='translate'>Snapshot Name</div>
						<input id='vboxSnapshotNewName' style='width: 100%'/>
						<div class='translate'>Snapshot Description</div>
						<textarea rows='10' id='vboxSnapshotNewDesc' style='width: 100%;'></textarea>
					</div>
				</td>
			</tr>
		</table>
	</div>


<!-- 

	Snapshot Details Dialog

 -->
	<div id='vboxSnapshotDetails' class='vboxDialogContent' style='display: none;'>
		<table class='vboxVertical'>
			<tr>
				<th><span class='translate'>Name:</span></th>
				<td>
					<input id='vboxSnapshotDetailsName' style='width: 100%'/>
				</td>
			</tr>
			<tr>
				<th><span class='translate'>Taken:</span></th>
				<td>
					<span id='vboxSnapshotDetailsTaken'></span>
				</td>
			</tr>
			<tr>
				<th><span class='translate'>Description:</span></th>
				<td>
					<textarea rows='12' id='vboxSnapshotDetailsDesc' name='vboxSnapshotDetailsDescElm'></textarea>
				</td>
			</tr>
			<tr>
				<th><span class='translate'>Details:</span></th>
				<td class='vboxSnapshotDetailsMachine'>
					<div id='vboxSnapshotDetailsVM' style='overflow: auto; height: 100%'></div>
				</td>
			</tr>
		</table>
	</div>



<script type='text/javascript'>

vboxSetLangContext('VBoxTakeSnapshotDlg');
vboxInitDisplay('vboxSnapshotNew');
vboxUnsetLangContext();

vboxSetLangContext('VBoxSnapshotDetailsDlg');
vboxInitDisplay('vboxSnapshotDetails');
vboxUnsetLangContext();

vboxSetLangContext('VBoxSnapshotsWgt');

var tButtons = [
            	
  	{
  		'name' : 'take_snapshot',
  		'label' : 'Take Snapshot',
  		'icon' : 'take_snapshot',
  		'enabled' : function(item) {
  			var vm = $('#vboxTabVMSnapshots').data('machine');
  			return (item && $(item).data('state') == 'current' && vm.state != 'RestoringSnapshot' && vm.state != 'LiveSnapshotting' && vm.state != 'DeletingSnapshot');
  		},
  		'click' : function () {

  			$('#vboxSnapshotNewImg').attr('src',"images/vbox/" + vboxGuestOSTypeIcon($('#vboxTabVMSnapshots').data('machine').OSTypeId));

  			vboxSetLangContext('VBoxSnapshotsWgt');
  			
  			var snRegEx = new RegExp('^' + trans('Snapshot %1').replace('%1','([0-9]+)') + '$');
  			
  			// Get max snapshot name
  			var snMax = 0;
  			var snList = $('#vboxSnapshotList').find('li');
  			for(var i = 0; i < snList.length; i++) {
  				var snNum = snRegEx.exec($(snList[i]).data('name'));
  				if(snNum) snMax = Math.max(parseInt(snNum[1]), snMax);
  			}
  			
  			$('#vboxSnapshotNewName').val(trans('Snapshot %1').replace('%1',(snMax+1)));
  			$('#vboxSnapshotNewDesc').val('');
  			
  			vboxUnsetLangContext();

  			
  			var buttons = {};
  			vboxSetLangContext('QIMessageBox');
  			buttons[trans('OK')] = function() {
	  	  		var l = new vboxLoader();
	  	  		l.mode = 'save';
	  	  		l.add('snapshotTake',function(d){
					if(d && d.progress) {
						vboxProgress(d.progress,function(){
							$('#vboxTabVMSnapshots').trigger('refresh');
						},{},'progress_snapshot_create_90px.png',trans('Take Snapshot','VBoxSnapshotsWgt'));
					} else if(d && d.error) {
						vboxAlert(d.error);
					}
	 	  		},{'vm':$('#vboxTabVMSnapshots').data('machine').id,'name':$('#vboxSnapshotNewName').val(),'description':$('#vboxSnapshotNewDesc').val()});
	 	  		$(this).dialog('close');
				l.run();
  			};
  			buttons[trans('Cancel')] = function() { $(this).dialog('close'); }
  			vboxUnsetLangContext();
  			
  			vboxSetLangContext('VBoxTakeSnapshotDlg');
  			$('#vboxSnapshotNew').dialog({'closeOnEscape':false,'width':'400px','height':'auto','buttons':buttons,'modal':true,'autoOpen':true,'stack':true,'dialogClass':'vboxDialogContent','title':'<img src="images/vbox/take_snapshot_16px.png" class="vboxDialogTitleIcon" /> ' + trans('Take Snapshot of Virtual Machine')});
  			vboxUnsetLangContext();
  			
  	  	},
  		'separator' : true
  	},
  	{
  		'name' : 'discard_cur_state',
  		'label' : 'Restore Snapshot',
  		'icon' : 'discard_cur_state',
  		'enabled' : function(item) {
			var vm = $('#vboxTabVMSnapshots').data('machine');
  			return ( item && $(item).data('name') && $(item).data('state') != 'current' && vm.state != 'Running' && vm.state != 'Paused');
  		},
  		'click' : function () {
  			
  	  		var snapshot = $('#vboxSnapshotList').find('div.vboxListItemSelected').first().parent().data();
  	  		
			var buttons = {};
			vboxSetLangContext('VBoxProblemReporter');
			
			// Check for saved state
			if($('#vboxTabVMSnapshots').data('machine').state == 'Saved' && $('#vboxTabVMSnapshots').data('machine').currentStateModified) {

				var q = trans('<p>You are about to restore snapshot <b>%1</b>.</p><p>You can create a snapshot of the current state of the virtual machine first by checking the box below; if you do not do this the current state will be permanently lost. Do you wish to proceed?</p>');
				q += '<p><label><input type="checkbox" id="vboxRestoreSnapshotCreate" checked /> ' + trans('Create a snapshot of the current machine state') + '</label></p>';
				
				buttons[trans('Restore')] = function() {

					var snrestore = function(){
			  	  		var l = new vboxLoader();
			  	  		l.mode = 'save';
			  	  		l.add('snapshotRestore',function(d){
							if(d && d.progress) {
								vboxSetLangContext('VBoxSnapshotsWgt');
								vboxProgress(d.progress,function(){
									$('#vboxTabVMSnapshots').trigger('refresh');
								},{},'progress_snapshot_restore_90px.png',trans('Restore Snapshot'));
								vboxUnsetLangContext();
							} else if(d && d.error) {
								vboxAlert(d.error);
							}
			 	  		},{'vm':$('#vboxTabVMSnapshots').data('machine').id,'snapshot':snapshot.id});
						l.run();										
					}
					
					if($('#vboxRestoreSnapshotCreate').prop('checked')) {
						tButtons[0].click(snrestore);
					} else {
						snrestore();
					}
		  	  		$(this).empty().remove();
				};

			} else {
				
				var q = trans('<p>Are you sure you want to restore snapshot <b>%1</b>?</p>');
				
				buttons[trans('Restore')] = function() {
		  	  		var l = new vboxLoader();
		  	  		l.mode = 'save';
		  	  		l.add('snapshotRestore',function(d){
						if(d && d.progress) {
							vboxSetLangContext('VBoxSnapshotsWgt');
							vboxProgress(d.progress,function(){
								$('#vboxTabVMSnapshots').trigger('refresh');
							},{},'progress_snapshot_restore_90px.png',trans('Restore Snapshot'));
							vboxUnsetLangContext();
						} else if(d && d.error) {
							vboxAlert(d.error);
						}
		 	  		},{'vm':$('#vboxTabVMSnapshots').data('machine').id,'snapshot':snapshot.id});
		  	  		$(this).empty().remove();
					l.run();				
				};
			}

			vboxConfirm(q.replace('%1',$('<div />').text(snapshot.name).html()),buttons);
			vboxUnsetLangContext();
  	  	},
  	},
  	{
  		'name' : 'delete_snapshot',
  		'label' : 'Delete Snapshot',
  		'icon' : 'delete_snapshot',
  		'enabled' : function(item) {
			var vm = $('#vboxTabVMSnapshots').data('machine');
  			return (item && $(item).data('name') && $(item).data('state') != 'current' && $(item).data('children').length <= 1);
  		},
  		'click' : function () {
  	  		var snapshot = $('#vboxSnapshotList').find('div.vboxListItemSelected').first().parent().data();
			var buttons = {};
			vboxSetLangContext('VBoxProblemReporter');
			buttons[trans('Delete')] = function() {
	  	  		var l = new vboxLoader();
	  	  		l.mode = 'save';
	  	  		l.add('snapshotDelete',function(d){
					if(d && d.progress) {
						vboxProgress(d.progress,function(){
							$('#vboxTabVMSnapshots').trigger('refresh');
						},{},'progress_snapshot_discard_90px.png',trans('Delete Snapshot','VBoxSnapshotsWgt'));
					} else if(d && d.error) {
						vboxAlert(d.error);
					}
	 	  		},{'vm':$('#vboxTabVMSnapshots').data('machine').id,'snapshot':snapshot.id});
	  	  		$(this).empty().remove();
				l.run();				
			};
			vboxConfirm(trans('<p>Deleting the snapshot will cause the state information saved in it to be lost, and disk data spread over several image files that VirtualBox has created together with the snapshot will be merged into one file. This can be a lengthy process, and the information in the snapshot cannot be recovered.</p></p>Are you sure you want to delete the selected snapshot <b>%1</b>?</p>').replace('%1',$('<div />').text(snapshot.name).html()),buttons);  	  		
			vboxUnsetLangContext();
  	  	},
  		'separator' : true
  	},
  	{
  		'name' : 'clone',
  		'label' : 'Clone...',
  		'icon' : 'vm_clone_16',
  		'icon_disabled' : 'vm_clone_disabled_16',
  		'context' : 'VBoxSelectorWnd',
  		'icon_exact' : true,
  		'separator' : true,
  		'enabled' : function(item) { return (item && $(item).data('name')) && $('#vboxTabVMSnapshots').data('machine').state != 'Running'},
  		'click' : function () {

  			// Current snapshot
  	  		var snapshot = $('#vboxSnapshotList').find('div.vboxListItemSelected').first().parent().data();
  			
  	  		vboxWizardCloneVMInit(function(){},{'vm':$('#vboxTabVMSnapshots').data('machine'),'snapshot':snapshot});
  			
  	  	}
  	},
  	
  	{
  		'name' : 'show_snapshot_details',
  		'label' : 'Show Details',
  		'icon' : 'show_snapshot_details',
  		'enabled' : function(item) { return (item && $(item).data('name') && $(item).data('state') != 'current'); },
  		'click' : function () {

  			// Current snapshot
  	  		var snapshot = $('#vboxSnapshotList').find('div.vboxListItemSelected').first().parent().data();
  			
			var l = new vboxLoader();
			l.add('SnapshotDetails',function(d){

				var sdate = new Date(d.timeStamp * 1000);
				sdate = sdate.toLocaleString();
				
				$('#vboxSnapshotDetailsName').val(d.name);
				$('#vboxSnapshotDetailsTaken').html(sdate);
				$('#vboxSnapshotDetailsDesc').val(d.description);
				
	  	  		// Display details
	  	  		$('#vboxSnapshotDetailsVM').empty();
	  	  		vboxSetLangContext('UIDetailsPagePrivate');
	  	  		__vboxDisplayDetailsData(d.machine,$('#vboxSnapshotDetailsVM'),false);
	  	  		vboxUnsetLangContext();
	  	  			  	  		
			},{'vm':$('#vboxTabVMSnapshots').data('machine').id,'snapshot':snapshot.id});
			l.onLoad = function(){
  			
	  			var buttons = {};
	  			vboxSetLangContext('QIMessageBox');
				buttons[trans('OK')] = function() {

		  			// Current snapshot
		  	  		var snapshot = $('#vboxSnapshotList').find('div.vboxListItemSelected').first().parent().data();
							
		  	  		var l = new vboxLoader();
		  	  		l.mode = 'save';
		  	  		l.add('saveSnapshot',function(d){
						$('#vboxTabVMSnapshots').trigger('refresh');
		 	  		},{'vm':$('#vboxTabVMSnapshots').data('machine').id,'snapshot':snapshot.id,'name':$('#vboxSnapshotDetailsName').val(),'description':$('#vboxSnapshotDetailsDesc').val()});
		 	  		$(this).dialog('close');
					l.run();
					
				};
				buttons[trans('Cancel')] = function(){
					$(this).dialog('close');
				};
				vboxUnsetLangContext();
				vboxSetLangContext('VBoxSnapshotDetailsDlg');
				$('#vboxSnapshotDetails').dialog({'closeOnEscape':false,'width':'600px','height':'auto','buttons':buttons,'modal':true,'autoOpen':true,'stack':true,'dialogClass':'vboxDialogContent','title':'<img src="images/vbox/show_snapshot_details_16px.png" class="vboxDialogTitleIcon" /> '+trans('Details of %1 (%2)').replace('%1',$('<div />').text(snapshot.name).html()).replace('%2',$('#vboxTabVMSnapshots').data('machine').name)});
				vboxUnsetLangContext();
			};
			l.run();
  	  	},
  	}
  	
  	
];


/* Append Top Toolbar */
snapshotToolbar = new vboxToolbarSmall(tButtons);
snapshotToolbar.size = 22;
snapshotToolbar.disabledString = 'dis';
snapshotToolbar.addButtons('vboxSnapshotToolbar');

// special case for 'clone' button because it is 16px rather than 22px
$('#vboxToolbarButton-vboxSnapshotToolbar-clone').css({'background-position':'6px 4px'});

// Hold timer and date vars
snapshotToolbar._timer = null;
snapshotToolbar._timeSpans = new Array();
snapshotToolbar._timeSpans['days'] = 86400;
snapshotToolbar._timeSpans['hours'] = 3600,
snapshotToolbar._timeSpans['minutes'] = 60,
snapshotToolbar._timeSpans['seconds'] = 1;
snapshotToolbar._timeSpans.sort(function(a,b){return (a > b ? -1 : 1);});



vboxInitDisplay('vboxSnapshotToolbar');

vboxUnsetLangContext();

$('#vboxSnapshotList').bind('select',snapshotToolbar.update);



// Called when snapshot operation completes
$('#vboxTabVMSnapshots').bind('refresh',function(){

	$('#vboxIndex').trigger('vmselect',$('#vboxTabVMSnapshots').data('machine'));
	
});


/* Loading VM */
$('#vboxIndex').bind('vmloading',function(){

	snapshotToolbar.disable();
	
	if(snapshotToolbar._timer) {
		window.clearTimeout(snapshotToolbar._timer);
		snapshotToolbar._timer = null;
	}
		
	$('#vboxTabVMSnapshots').data('lastVM',0);
	
	$('#vboxSnapshotList').children().remove();
	
	vboxSetLangContext('UIVMDesktop');
	$('#vboxTabVMSnapshotsTitle').html(trans('Snapshots'));
	vboxUnsetLangContext();
	
	// Append spinner
	$('#vboxSnapshotList').append($('<li />').attr({'class':'last'}).html("<div><img src='images/spinner.gif'></div>"));
	
/* VM Finished loading */
}).bind('vmloaded',function(e,vm){

	$('#vboxTabVMSnapshots').data('machine',vm);
	
	vboxSetLangContext('UIVMDesktop');
	$('#vboxTabVMSnapshotsTitle').html(trans('Snapshots') + (vm && vm.snapshotCount ? trans(' (%1)').replace('%1',vm.snapshotCount):''));
	vboxUnsetLangContext();
	
	if(snapshotToolbar._timer)
		window.clearTimeout(snapshotToolbar._timer);

});


// Load snapshots on show
$('#vboxTabVMSnapshots').bind('show',function(e,vm){

	if(snapshotToolbar._timer) {
		window.clearTimeout(snapshotToolbar._timer);
		snapshotToolbar._timer = null;
	}

	if(vm && vm.id) {
		if($('#vboxTabVMSnapshots').data('lastVM') == vm.id) return;
		$('#vboxTabVMSnapshots').data('lastVM',vm.id);
	} else {
		$('#vboxTabVMSnapshots').data('lastVM',0);
	}
	
	$('#vboxSnapshotList').children().remove();
	
	if(!vm || vm.id == 'host') {
		snapshotToolbar.disable();
		return;
	}

	// Append spinner
	$('#vboxSnapshotList').append($('<li />').attr({'class':'last'}).html("<div><img src='images/spinner.gif'></div>"));
	
	// Get snapshots
	vboxAjaxRequest('getSnapshots',{'vm':vm.id},__vboxTabSnapshotsFill);

	
});

/*
 * Fill Snapshots
*/
function __vboxTabSnapshotsFill(s) {

	var list = $('#vboxSnapshotList');
	$(list).children().remove();

	if(snapshotToolbar._timer) {
		window.clearTimeout(snapshotToolbar._timer);
		snapshotToolbar._timer = null;
	}
	
	if(!s) return;

	// Snapshots exist
	if(s.name) {

		// Traverse snapshots
		$(list).append(__vboxTabSnapshot(s));
	
		// Append current state to last snapshot
		if($('#vboxTabVMSnapshots').data('machine').currentSnapshot && $('#vboxTabVMSnapshots').data('machine').currentSnapshot.id) {
	
			// Has children
			if($('#'+$('#vboxTabVMSnapshots').data('machine').currentSnapshot.id).children('ul').first().html()) {
				$('#'+$('#vboxTabVMSnapshots').data('machine').currentSnapshot.id).children('ul').last().append(__vboxTabSnapshotCurrent());
			} else {
				$('#'+$('#vboxTabVMSnapshots').data('machine').currentSnapshot.id).append($('<ul />').append(__vboxTabSnapshotCurrent()));
			}
		}			
		
	// No snapshots. Append current state to list
	} else {
		$(list).append(__vboxTabSnapshotCurrent());
	}
	
	// Init vbox tree list
	$('#vboxSnapshotList').vbtree();
	
	snapshotToolbar.enable();

	$('#vboxSnapshotList').trigger('select');

	__vboxTabSnapshotTimestamps();	

}

/* Snapshot list item */
function __vboxTabSnapshot(s) {

	var li = $('<li />').attr({'id':s.id});
	$(li).data(s);
	
	// Use timestamp
	var t = '';
	if(s.timeStampSplit['seconds'] == 0)
		s.timeStampSplit['seconds'] = 1;

	var ago = 0;
	var ts = 'seconds';
	for(var i in s.timeStampSplit) {
		var l = Math.floor(t / s.timeStampSplit[i]);
		if(l > 0) {
			ago = l;
			ts = i
			break;
		}
	}

	vboxSetLangContext('VBoxGlobal');
	switch(ts) {
		case 'days':
			ts = trans('%n day(s)', undefined, ago).replace('%n', ago);
			break;
		case 'hours':
			ts = trans('%n hour(s)', ago).replace('%n', ago);
			break;				
		case 'minutes':
			ts = trans('%n minute(s)', undefined, ago).replace('%n', ago);
			break;				
		case 'seconds':
			ts = trans('%n second(s)', undefined, ago).replace('%n', ago);
			break;				
	}
	vboxUnsetLangContext();
	vboxSetLangContext('VBoxSnapshotsWgt');
	ts = trans(' (%1 ago)').replace('%1', ts);
	vboxUnsetLangContext();
	
	$(li).html(' <div class="vboxListItem"><img src="images/vbox/'+(s.online ? 'online' : 'offline')+'_snapshot_16px.png" /> ' + $('<div />').text(s.name).html()+'<span class="timestamp" title="'+s.timeStamp +'">'+ts+'</span></div>');
	if(s.children.length) {
		var ul = $('<ul />');
		for(var i = 0; i < s.children.length; i++) {
			$(ul).append(__vboxTabSnapshot(s.children[i]));
		}
		$(li).append(ul);
	}
		
	
	return li;
}

/* Current state list item */
function __vboxTabSnapshotCurrent() {

	vboxSetLangContext('VBoxSnapshotsWgt');
	
	// Add 'current state'
	var li = $('<li />').data({'state':'current','name':trans(($('#vboxTabVMSnapshots').data('machine').currentStateModified ? 'Current State (changed)' : 'Current State'))}).html(' <div class="vboxListItem"><img src="images/vbox/'+vboxMachineStateIcon($('#vboxTabVMSnapshots').data('machine').state)+'" /> ' + $('<div />').text(trans(($('#vboxTabVMSnapshots').data('machine').currentStateModified ? 'Current State (changed)' : 'Current State'))).html()+'</div>');

	$(li).addClass('last').addClass('vboxSnapshotCurrent');
	
	vboxUnsetLangContext();
	
	return li;
}

/* Update snapshot timestamps */
function __vboxTabSnapshotTimestamps() {
	
	// Shorthand
	var timeSpans = snapshotToolbar._timeSpans;
	
	// Keep minimum timestamp
	var minTs = 60;

	var currentTime = new Date();
	currentTime = Math.floor(currentTime.getTime() / 1000);

	$('#vboxTabVMSnapshots').find('span.timestamp').each(function(){
		
		var sts = parseInt($(this).attr('title'));
		var t = Math.max(currentTime - sts, 1);
		var ts = $(this).html();
		
		minTs = Math.min(minTs,t);
		
		// Check for max age.
		if(Math.floor(t / 86400) > 30) {
			var sdate = new Date(sts * 1000);
			$(this).html(trans(' (%1)').replace('%1',sdate.toLocaleString()));
			return;
		}
		
		vboxSetLangContext('VBoxGlobal');
		var ago = 0;
		var ts = 'seconds';
		for(var i in timeSpans) {
			var l = Math.floor(t / timeSpans[i]);
			if(l > 0) {
				ago = l;
				ts = i
				//ts =  trans('X ago').replace('%s',(Math.floor(t / timeSpans[i]) + ' ' + trans(i)));
				break;
			}
		}
		switch(ts) {
			case 'days':
				ts = trans('%n day(s)', undefined, ago).replace('%n', ago);
				break;
			case 'hours':
				ts = trans('%n hour(s)', undefined, ago).replace('%n', ago);
				break;				
			case 'minutes':
				ts = trans('%n minute(s)', undefined, ago).replace('%n', ago);
				break;				
			case 'seconds':
				ts = trans('%n second(s)', undefined, ago).replace('%n', ago);
				break;				
		}
		vboxUnsetLangContext();
		vboxSetLangContext('VBoxSnapshotsWgt');
		$(this).html(ts = trans(' (%1 ago)').replace('%1', ts));
		vboxUnsetLangContext();
	});
	
	var timerSet = (minTs >= 60 ? 60 : 10);
	snapshotToolbar._timer = window.setTimeout(__vboxTabSnapshotTimestamps,(timerSet * 1000));
}

vboxUnsetLangContext();

</script>
</div>